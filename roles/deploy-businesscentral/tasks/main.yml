---
- name: "[BUSINESS CENTRAL] set service state to {{ state }}"
  k8s_raw:
    state: '{{ state }}'
    definition:
      apiVersion: v1
      kind: Service
      name: '{{ businesscentral_deployment_name }}'
      namespace: '{{ namespace }}'
      labels:
        app: '{{ application_name }}'
        service: '{{ businesscentral_service_name }}'
      spec:
        selector:
          app: '{{ application_name }}'
          service: '{{ businesscentral_service_name }}'
          deploymentconfig: '{{ businesscentral_deployment_name }}'
        ports:
          - name: http
            port: 8080
            targetPort: 8080
          - name: https
            port: 8443
            targetPort: 8443
          - name: git-ssh
            port: 8001
            targetPort: 8001

- name: "[BUSINESS CENTRAL] set https route state to {{ state }}"
  openshift_raw:
    state: '{{ state }}'
    definition:
      apiVersion: v1
      kind: Route
      name: '{{ businesscentral_deployment_name }}'
      namespace: '{{ namespace }}'
      labels:
        app: '{{ application_name }}'
        service: '{{ businesscentral_service_name }}'
      spec:
        host: '{{ businesscentral_hostname }}'
        port:
          targetPort: https
        tls:
          termination: passthrough
          insecureEdgeTerminationPolicy: Redirect
        to:
          kind: Service
          name: '{{ businesscentral_deployment_name }}'
  register: route_raw

- name: "[BUSINESS CENTRAL] set persistent volume claim state to {{ state }}"
  k8s_raw:
    state: '{{ state }}'
    definition:
      apiVersion: v1
      kind: PersistentVolumeClaim
      name: '{{ businesscentral_deployment_name }}-data'
      namespace: '{{ namespace }}'
      labels:
        app: '{{ application_name }}'
        service: '{{ businesscentral_service_name }}'
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: '{{ businesscentral_volume_size }}'
  when: businesscentral_volume_size != ""

- name: "[BUSINESS CENTRAL] Set default secret name if none provided"
  set_fact:
    bc_secret_name: "{{ businesscentral_secret_name | default(businesscentral_default_secret_name, true) }}"

- name: "[BUSINESS CENTRAL] generate secret if not present"
  include_role:
    name: generate-secret
  vars:
    secret_name: '{{ bc_secret_name }}'
    service_name: '{{ businesscentral_service_name }}'
    keystore_name: '{{ businesscentral_keystore_name }}'
    keystore_alias: '{{ businesscentral_keystore_alias }}'
    keystore_pwd: '{{ businesscentral_keystore_pwd }}'
    route_host: '{{ route_raw.result.spec.host }}'

- name: "[BUSINESS CENTRAL] deploy business central"
  openshift_raw:
    state: '{{ state }}'
    definition: "{{ lookup('template', 'businesscentral-dc.yml.j2') | from_yaml }}"
